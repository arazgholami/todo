<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="A simple todo application that works offline">
    <title>ToDo</title>
    <link rel="shortcut icon" href="./todo-icon.png?ver=1.39" type="image/png">
    <link rel="apple-touch-icon" href="./todo-icon.png?ver=1.39">
    <link rel="manifest" href="./manifest.json?ver=1.39">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css?ver=1.39">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/9.0.1/uuid.min.js"></script>
    <script>
        if (new URLSearchParams(window.location.search).get('debug') === 'true') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/eruda';
            script.onload = () => eruda.init();
            document.head.appendChild(script);
        }
    </script>
    <script src="script.js?ver=1.39" defer></script>
</head>
<body>
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>

    <div class="content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3 col-lg-3 sidebar p-0">
                    <div class="p-3">
                        <div id="categories-list"></div>

                        <div class="mt-4">
                            <div class="input-group">
                                <input type="text" id="new-category-input" class="form-control" placeholder="New category">
                                <button class="btn btn-outline-light" id="add-category-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="card sync">
                                <div class="card-body p-2 d-flex flex-column align-items-stretch gap-2">
                                    <label for="sync-userid" class="form-label mb-1">Sync</label>
                                    <input type="text" id="sync-userid" class="form-control form-control-sm mb-2" style="max-width:100%;" readonly>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-outline-primary btn-sm flex-fill" id="push-btn">Push</button>
                                        <button class="btn btn-outline-success btn-sm flex-fill" id="pull-btn">Pull</button>
                                    </div>
                                    <span id="sync-message" class="text-muted small mt-1"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-9 col-lg-9 tasks-list">
                    <input type="text" id="current-category-title" class="category-title-input main-content" readonly>
                    <div class="todo-input">
                        <div class="input-group align-items-center">
                            <input type="text" id="new-todo-input" class="form-control border-0 flex-grow-1" style="min-width:0;" placeholder="I want to...">
                            <input type="url" id="new-todo-link" class="form-control border-0" placeholder="Optional link (https://)">
                            <button class="btn btn-primary" id="save-task-btn">Save</button>
                        </div>
                    </div>
                    <div class="todo-list" id="todo-items-container">
                        <div id="active-items">
                        </div>
                        <div id="completed-items">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <a href="https://arazgholami.github.io/todo/" target="_blank" rel="noopener noreferrer" class="text-decoration-none logo-wrapper">
            <span class="logo">
                <img src="todo.png?ver=1.39" alt="ToDo Logo">
                ToDo
            </span>
        </a>
        <span class="author">Reimagined by Araz Gholami</span>
        <div class="footer-links">
            <a href="https://github.com/arazgholami/todo" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> GitHub</a>
            <a href="mailto:contact@arazgholami.com" target="_blank" rel="noopener noreferrer"><i class="fas fa-envelope"></i> Contact</a>
        </div>
    </div>
    <div class="modal fade" id="moveTaskModal" tabindex="-1" aria-labelledby="moveTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moveTaskModalLabel">Move Task to Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <select id="category-select" class="form-select category-dropdown">
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-move-btn">Move</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteTaskModalLabel">Delete Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this task?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCategoryModalLabel">Delete Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this category? All tasks in this category will be moved to the General category.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-category-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reminderModalLabel">Set Reminder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reminder-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="reminder-date">
                    </div>
                    <div class="mb-3">
                        <label for="reminder-time" class="form-label">Time</label>
                        <input type="time" class="form-control" id="reminder-time">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-reminder-btn">Set Reminder</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- SYNC SECTION ---
        const FIREBASE_PROJECT = 'todo-f4e76';
        const SYNC_COLLECTION = 'todos';
        const USERID_KEY = 'sync_userid';
        const SYNC_MESSAGE = document.getElementById('sync-message');
        const SYNC_USERID_INPUT = document.getElementById('sync-userid');
        // Generate 8-char alphanumeric userId
        function generateUserId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            for (let i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
            return id;
        }
        // Get or create userId
        function getUserId() {
            let id = localStorage.getItem(USERID_KEY);
            if (!id) {
                id = generateUserId();
                localStorage.setItem(USERID_KEY, id);
            }
            return id;
        }
        // Set userId in UI
        function setUserIdUI() {
            SYNC_USERID_INPUT.value = getUserId();
        }
        setUserIdUI();
        // --- PUSH ---
        async function pushTodos(userId, todos, categories) {
            try {
                await fetch(`https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT}/databases/(default)/documents/${SYNC_COLLECTION}/${userId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fields: {
                            data: { stringValue: JSON.stringify({ todos, categories }) },
                            timestamp: { timestampValue: new Date().toISOString() }
                        }
                    })
                });
                SYNC_MESSAGE.textContent = 'Pushed successfully!';
                SYNC_MESSAGE.className = 'ms-2 text-success small';
            } catch (err) {
                SYNC_MESSAGE.textContent = 'Error: ' + err.message;
                SYNC_MESSAGE.className = 'ms-2 text-danger small';
            }
        }
        // --- PULL ---
        async function pullTodos(userId) {
            try {
                const response = await fetch(`https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT}/databases/(default)/documents/${SYNC_COLLECTION}/${userId}`);
                if (!response.ok) throw new Error('Not found or network error');
                const data = await response.json();
                if (!data.fields || !data.fields.data) throw new Error('No data found');
                const remote = JSON.parse(data.fields.data.stringValue);
                SYNC_MESSAGE.textContent = 'Pulled successfully!';
                SYNC_MESSAGE.className = 'ms-2 text-success small';
                return remote;
            } catch (err) {
                SYNC_MESSAGE.textContent = 'Error: ' + err.message;
                SYNC_MESSAGE.className = 'ms-2 text-danger small';
                return null;
            }
        }
        // --- MERGE ---
        function mergeById(localArr, remoteArr) {
            const map = new Map();
            for (const item of localArr) map.set(item.id, item);
            for (const item of remoteArr) map.set(item.id, item);
            return Array.from(map.values());
        }
        // --- HOOKUP BUTTONS ---
        document.getElementById('push-btn').onclick = async () => {
            SYNC_MESSAGE.textContent = 'Pushing...';
            SYNC_MESSAGE.className = 'ms-2 text-muted small';
            // Get all todos and categories from localForage
            const [todos, categories] = await Promise.all([
                localforage.getItem('todos').then(x => x || []),
                localforage.getItem('categories').then(x => x || [])
            ]);
            // Ensure each todo has a unique id
            for (const t of todos) {
                if (!t.id) t.id = uuid.v4();
            }
            for (const c of categories) {
                if (!c.id) c.id = uuid.v4();
            }
            await localforage.setItem('todos', todos);
            await localforage.setItem('categories', categories);
            await pushTodos(getUserId(), todos, categories);
        };
        document.getElementById('pull-btn').onclick = async () => {
            SYNC_MESSAGE.textContent = 'Pulling...';
            SYNC_MESSAGE.className = 'ms-2 text-muted small';
            const remote = await pullTodos(getUserId());
            if (!remote) return;
            // Get local
            const [localTodos, localCategories] = await Promise.all([
                localforage.getItem('todos').then(x => x || []),
                localforage.getItem('categories').then(x => x || [])
            ]);
            // Merge
            const mergedTodos = mergeById(localTodos, remote.todos || []);
            const mergedCategories = mergeById(localCategories, remote.categories || []);
            await localforage.setItem('todos', mergedTodos);
            await localforage.setItem('categories', mergedCategories);
            // Optionally, refresh UI if you have a function for that
            if (typeof renderTodos === 'function') renderTodos();
            if (typeof renderCategories === 'function') renderCategories();
        };
        // ...existing code...
    </script>
    <!-- ...existing code... -->
</body>
</html>